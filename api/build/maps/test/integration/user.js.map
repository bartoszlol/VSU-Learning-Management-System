{"version":3,"sources":["test/integration/user.ts"],"names":[],"mappings":";;;;;;;;;;AAAA,6BAA6B;AAE7B,6CAAwC;AACxC,gEAA2D;AAC3D,0DAAqD;AACrD,gDAA2C;AAC3C,4DAAuD;AACvD,8DAAyD;AAEzD,kDAAgD;AAChD,sCAAuC;AACvC,yBAA0B;AAE1B,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;AACnB,MAAM,MAAM,GAAG,IAAI,CAAC,MAAM,EAAE,CAAC;AAC7B,MAAM,GAAG,GAAG,IAAI,eAAM,EAAE,CAAC,GAAG,CAAC;AAC7B,MAAM,QAAQ,GAAG,YAAY,CAAC;AAC9B,MAAM,QAAQ,GAAG,QAAQ,GAAG,QAAQ,CAAC;AACrC,MAAM,UAAU,GAAG,QAAQ,GAAG,iBAAiB,CAAC;AAChD,MAAM,aAAa,GAAG,IAAI,6BAAa,EAAE,CAAC;AAE1C,QAAQ,CAAC,MAAM,EAAE,GAAG,EAAE;IACpB,yCAAyC;IACzC,UAAU,CAAC,GAAS,EAAE;QACpB,MAAM,aAAa,CAAC,IAAI,EAAE,CAAC;IAC7B,CAAC,CAAA,CAAC,CAAC;IAEH,QAAQ,CAAC,OAAO,QAAQ,EAAE,EAAE,GAAG,EAAE;QAC/B,EAAE,CAAC,yBAAyB,EAAE,GAAS,EAAE;YACvC,MAAM,OAAO,GAAG,MAAM,2BAAY,CAAC,gBAAgB,EAAE,CAAC;YAEtD,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC;iBAChC,GAAG,CAAC,QAAQ,CAAC;iBACb,GAAG,CAAC,QAAQ,EAAE,SAAS,mBAAQ,CAAC,aAAa,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC;YAE7D,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YAChC,GAAG,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC;YAC9B,GAAG,CAAC,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,MAAM,2BAAY,CAAC,YAAY,EAAE,CAAC,CAAC;QACrE,CAAC,CAAA,CAAC,CAAC;QAEH,EAAE,CAAC,sCAAsC,EAAE,GAAS,EAAE;YAEpD,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC;iBAChC,GAAG,CAAC,QAAQ,CAAC;iBACb,GAAG,CAAC,eAAe,EAAE,UAAU,CAAC;iBAChC,KAAK,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;YAE9B,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;QAClC,CAAC,CAAA,CAAC,CAAC;QAEH,EAAE,CAAC,yCAAyC,EAAE,GAAS,EAAE;YACvD,MAAM,KAAK,GAAG,MAAM,2BAAY,CAAC,cAAc,EAAE,CAAC;YAElD,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC;iBAChC,GAAG,CAAC,GAAG,QAAQ,IAAI,KAAK,CAAC,GAAG,EAAE,CAAC;iBAC/B,GAAG,CAAC,QAAQ,EAAE,SAAS,mBAAQ,CAAC,aAAa,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC;YAE3D,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YAChC,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,KAAK,CAAC,GAAG,CAAC,QAAQ,EAAE,CAAC,CAAC;YACnD,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;QAC9C,CAAC,CAAA,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,OAAO,QAAQ,EAAE,EAAE,GAAG,EAAE;QAC/B,EAAE,CAAC,oCAAoC,EAAE,GAAS,EAAE;YAClD,MAAM,OAAO,GAAG,MAAM,2BAAY,CAAC,gBAAgB,EAAE,CAAC;YAEtD,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC;iBAChC,GAAG,CAAC,QAAQ,CAAC;iBACb,GAAG,CAAC,QAAQ,EAAE,SAAS,mBAAQ,CAAC,aAAa,CAAC,OAAO,CAAC,EAAE,CAAC;iBACzD,KAAK,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;YAE9B,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;QAClC,CAAC,CAAA,CAAC,CAAC;QAEH,EAAE,CAAC,+CAA+C,EAAE,GAAS,EAAE;YAC7D,MAAM,KAAK,GAAG,MAAM,2BAAY,CAAC,cAAc,EAAE,CAAC;YAElD,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC;iBAChC,GAAG,CAAC,QAAQ,CAAC;iBACb,GAAG,CAAC,QAAQ,EAAE,SAAS,mBAAQ,CAAC,aAAa,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC;YAE3D,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YAChC,GAAG,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC;YAC9B,GAAG,CAAC,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,gBAAQ,CAAC,MAAM,CAAC,CAAC;YACjD,GAAG,CAAC,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,gBAAQ,CAAC,CAAC;QAC9C,CAAC,CAAA,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,OAAO,UAAU,EAAE,EAAE,GAAG,EAAE;QACjC,EAAE,CAAC,6BAA6B,EAAE,GAAS,EAAE;YAC3C,MAAM,OAAO,GAAG,MAAM,2BAAY,CAAC,gBAAgB,EAAE,CAAC;YACtD,MAAM,OAAO,GAAU,IAAI,WAAI,CAAC;gBAC9B,GAAG,EAAE,QAAQ;gBACb,KAAK,EAAE,eAAe;gBACtB,QAAQ,EAAE,YAAY;gBACtB,OAAO,EAAE;oBACP,SAAS,EAAE,KAAK;oBAChB,QAAQ,EAAE,YAAY;iBACvB;gBACD,IAAI,EAAE,SAAS;aAChB,CAAC,CAAC;YACH,MAAM,WAAW,GAAG,MAAM,WAAI,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC;YAC/C,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC;iBAChC,GAAG,CAAC,UAAU,CAAC;iBACf,KAAK,CAAC;gBACL,IAAI,EAAE,OAAO,CAAC,IAAI;gBAClB,KAAK,EAAE,OAAO,CAAC,GAAG;oBAClB,GAAG,GAAG,OAAO,CAAC,KAAK;oBACnB,GAAG,GAAG,OAAO,CAAC,OAAO,CAAC,SAAS;oBAC/B,GAAG,GAAG,OAAO,CAAC,OAAO,CAAC,QAAQ;gBAC9B,KAAK,EAAE,CAAC;aACT,CAAC;iBACD,GAAG,CAAC,QAAQ,EAAE,SAAS,mBAAQ,CAAC,aAAa,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC;YAE7D,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YAChC,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,EAAE,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC;YAC7C,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC;YAC/C,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,SAAS,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,OAAO,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC;YAC/E,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,SAAS,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,OAAO,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC;YAC/E,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;YACnD,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;QACzD,CAAC,CAAA,CAAC,CAAC;QAEH,EAAE,CAAC,6BAA6B,EAAE,GAAS,EAAE;YAC3C,MAAM,OAAO,GAAG,MAAM,2BAAY,CAAC,gBAAgB,EAAE,CAAC;YACtD,MAAM,OAAO,GAAU,IAAI,WAAI,CAAC;gBAC9B,GAAG,EAAE,QAAQ;gBACb,KAAK,EAAE,eAAe;gBACtB,QAAQ,EAAE,YAAY;gBACtB,OAAO,EAAE;oBACP,SAAS,EAAE,KAAK;oBAChB,QAAQ,EAAE,YAAY;iBACvB;gBACD,IAAI,EAAE,SAAS;aAChB,CAAC,CAAC;YACH,MAAM,WAAW,GAAG,MAAM,WAAI,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC;YAC/C,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC;iBAChC,GAAG,CAAC,UAAU,CAAC;iBACf,KAAK,CAAC;gBACL,IAAI,EAAE,SAAS;gBACf,KAAK,EAAE,OAAO,CAAC,GAAG;oBAClB,GAAG,GAAG,OAAO,CAAC,KAAK;oBACnB,GAAG,GAAG,OAAO,CAAC,OAAO,CAAC,SAAS;oBAC/B,GAAG,GAAG,OAAO,CAAC,OAAO,CAAC,QAAQ;aAC/B,CAAC;iBACD,GAAG,CAAC,QAAQ,EAAE,SAAS,mBAAQ,CAAC,aAAa,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC;YAE7D,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YAChC,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,EAAE,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC;YAC7C,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC;YAC/C,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,SAAS,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,OAAO,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC;YAC/E,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,SAAS,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,OAAO,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC;YAC/E,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;YACnD,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;QACzD,CAAC,CAAA,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,OAAO,QAAQ,EAAE,EAAE,GAAG,EAAE;QAC/B,SAAS,iBAAiB,CAAC,WAAkB,EAAE,WAAkB;YAC/D,OAAO,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC;iBACrB,GAAG,CAAC,GAAG,QAAQ,IAAI,WAAW,CAAC,GAAG,EAAE,CAAC;iBACrC,GAAG,CAAC,QAAQ,EAAE,SAAS,mBAAQ,CAAC,aAAa,CAAC,WAAW,CAAC,EAAE,CAAC;iBAC7D,IAAI,CAAC,WAAW,CAAC,CAAC;QACvB,CAAC;QAED,SAAS,yBAAyB,CAAC,WAAkB,EAAE,WAAkB;YACvE,OAAO,iBAAiB,CAAC,WAAW,EAAE,WAAW,CAAC,CAAC,KAAK,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;QAChF,CAAC;QAED,SAAS,aAAa,CAAC,GAAqB,EAAE,MAAc,EAAE,IAAY,EAAE,OAAe;YACzF,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;YACnC,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;YACpC,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC;QAC5C,CAAC;QAED,EAAE,CAAC,4DAA4D,EAAE,GAAS,EAAE;YAC1E,MAAM,KAAK,GAAG,MAAM,2BAAY,CAAC,cAAc,EAAE,CAAC;YAClD,MAAM,WAAW,GAAG,KAAK,CAAC;YAC1B,WAAW,CAAC,IAAI,GAAG,SAAS,CAAC;YAE7B,MAAM,GAAG,GAAG,MAAM,yBAAyB,CAAC,KAAK,EAAE,WAAW,CAAC,CAAC;YAChE,aAAa,CAAC,GAAG,EAAE,GAAG,EAAE,iBAAiB,EAAE,uBAAU,CAAC,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC,CAAC;QACrF,CAAC,CAAA,CAAC,CAAC;QAEH,EAAE,CAAC,qDAAqD,EAAE,GAAS,EAAE;YACnE,MAAM,KAAK,GAAG,MAAM,2BAAY,CAAC,cAAc,EAAE,CAAC;YAClD,MAAM,WAAW,GAAG,MAAM,2BAAY,CAAC,gBAAgB,EAAE,CAAC;YAC1D,WAAW,CAAC,KAAK,GAAG,KAAK,CAAC,KAAK,CAAC;YAEhC,MAAM,GAAG,GAAG,MAAM,yBAAyB,CAAC,KAAK,EAAE,WAAW,CAAC,CAAC;YAChE,aAAa,CAAC,GAAG,EAAE,GAAG,EAAE,iBAAiB,EAAE,uBAAU,CAAC,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC,CAAC;QACrF,CAAC,CAAA,CAAC,CAAC;QAEH,gHAAgH;QAChH,wFAAwF;QACxF,sFAAsF;QACtF;;;;;;;;;UASE;QAEF,EAAE,CAAC,mFAAmF,EAAE,GAAS,EAAE;YACjG,MAAM,CAAC,OAAO,EAAE,WAAW,CAAC,GAAG,MAAM,2BAAY,CAAC,iBAAiB,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;YAC1E,WAAW,CAAC,OAAO,CAAC,SAAS,GAAG,MAAM,CAAC;YAEvC,MAAM,GAAG,GAAG,MAAM,yBAAyB,CAAC,OAAO,EAAE,WAAW,CAAC,CAAC;YAClE,aAAa,CAAC,GAAG,EAAE,GAAG,EAAE,gBAAgB,EAAE,uBAAU,CAAC,IAAI,CAAC,4BAA4B,CAAC,IAAI,CAAC,CAAC;QAC/F,CAAC,CAAA,CAAC,CAAC;QAEH,EAAE,CAAC,+CAA+C,EAAE,GAAS,EAAE;YAC7D,MAAM,OAAO,GAAG,MAAM,2BAAY,CAAC,gBAAgB,EAAE,CAAC;YACtD,MAAM,WAAW,GAAG,OAAO,CAAC;YAC5B,WAAW,CAAC,QAAQ,GAAG,SAAS,CAAC;YACjC,WAAW,CAAC,OAAO,CAAC,SAAS,GAAG,SAAS,CAAC;YAC1C,WAAW,CAAC,OAAO,CAAC,QAAQ,GAAG,MAAM,CAAC;YACtC,WAAW,CAAC,KAAK,GAAG,wBAAwB,CAAC;YAE7C,MAAM,GAAG,GAAG,MAAM,iBAAiB,CAAC,OAAO,EAAE,WAAW,CAAC,CAAC;YAC1D,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YAChC,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC;YACtD,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;YAClD,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,wBAAwB,CAAC,CAAC;QAC3D,CAAC,CAAA,CAAC,CAAC;QAEH,EAAE,CAAC,yBAAyB,EAAE,GAAS,EAAE;YACvC,MAAM,OAAO,GAAG,MAAM,2BAAY,CAAC,gBAAgB,EAAE,CAAC;YACtD,MAAM,WAAW,GAAG,OAAO,CAAC;YAC5B,WAAW,CAAC,QAAQ,GAAG,EAAE,CAAC;YAC1B,WAAW,CAAC,OAAO,CAAC,SAAS,GAAG,SAAS,CAAC;YAC1C,WAAW,CAAC,OAAO,CAAC,QAAQ,GAAG,MAAM,CAAC;YACtC,WAAW,CAAC,KAAK,GAAG,wBAAwB,CAAC;YAE7C,MAAM,GAAG,GAAG,MAAM,iBAAiB,CAAC,OAAO,EAAE,WAAW,CAAC,CAAC;YAC1D,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YAChC,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC;YACtD,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;YAClD,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,wBAAwB,CAAC,CAAC;QAC3D,CAAC,CAAA,CAAC,CAAC;QAEH,EAAE,CAAC,+CAA+C,EAAE,GAAS,EAAE;YAC7D,MAAM,OAAO,GAAG,MAAM,2BAAY,CAAC,gBAAgB,EAAE,CAAC;YACtD,MAAM,WAAW,GAAG,OAAO,CAAC;YAC5B,WAAW,CAAC,QAAQ,GAAG,SAAS,CAAC;YACjC,WAAW,CAAC,OAAO,CAAC,SAAS,GAAG,SAAS,CAAC;YAC1C,WAAW,CAAC,OAAO,CAAC,QAAQ,GAAG,MAAM,CAAC;YACtC,WAAW,CAAC,KAAK,GAAG,uBAAuB,CAAC;YAE5C,MAAM,GAAG,GAAG,MAAM,iBAAiB,CAAC,OAAO,EAAE,WAAW,CAAC,CAAC;YAC1D,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YAChC,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC;YACtD,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;YAClD,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,uBAAuB,CAAC,CAAC;QAC1D,CAAC,CAAA,CAAC,CAAC;QAEH,EAAE,CAAC,4BAA4B,EAAE,GAAS,EAAE;YAC1C,MAAM,KAAK,GAAG,MAAM,2BAAY,CAAC,cAAc,EAAE,CAAC;YAClD,MAAM,OAAO,GAAG,MAAM,2BAAY,CAAC,gBAAgB,EAAE,CAAC;YACtD,MAAM,OAAO,GAAG,OAAO,CAAC,GAAG,CAAC;YAC5B,MAAM,WAAW,GAAG,OAAO,CAAC;YAC5B,WAAW,CAAC,GAAG,GAAG,IAAI,CAAC;YACvB,WAAW,CAAC,QAAQ,GAAG,EAAE,CAAC;YAC1B,WAAW,CAAC,OAAO,CAAC,SAAS,GAAG,SAAS,CAAC;YAC1C,WAAW,CAAC,OAAO,CAAC,QAAQ,GAAG,MAAM,CAAC;YACtC,WAAW,CAAC,KAAK,GAAG,uBAAuB,CAAC;YAE5C,MAAM,GAAG,GAAG,MAAM,iBAAiB,CAAC,KAAK,EAAE,WAAW,CAAC,CAAC;YACxD,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YAChC,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC;YACtC,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC;YACtD,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;YAClD,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,uBAAuB,CAAC,CAAC;QAC1D,CAAC,CAAA,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,QAAQ,QAAQ,UAAU,EAAE,GAAG,EAAE;QACxC,SAAe,qBAAqB,CAAC,WAAkB,EAAE,UAAiB;;gBACxE,OAAO,MAAM,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC;qBAC3B,IAAI,CAAC,GAAG,QAAQ,YAAY,UAAU,CAAC,GAAG,EAAE,CAAC;qBAC7C,GAAG,CAAC,QAAQ,EAAE,SAAS,mBAAQ,CAAC,aAAa,CAAC,WAAW,CAAC,EAAE,CAAC;qBAC7D,MAAM,CAAC,MAAM,EAAE,EAAE,CAAC,YAAY,CAAC,yBAAyB,CAAC,EAAE,UAAU,CAAC,CAAC;YAC5E,CAAC;SAAA;QAED,SAAS,aAAa,CAAC,GAAqB;YAC1C,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YAChC,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE,CAAC,EAAE,CAAC,QAAQ,CAAC,CAAC;YAChD,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,OAAO,EAAE,MAAM,EAAE,MAAM,CAAC,CAAC;YACvE,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,KAAK,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC;QAC7D,CAAC;QAED,EAAE,CAAC,kCAAkC,EAAE,GAAS,EAAE;YAChD,MAAM,KAAK,GAAG,MAAM,2BAAY,CAAC,cAAc,EAAE,CAAC;YAClD,MAAM,GAAG,GAAG,MAAM,qBAAqB,CAAC,KAAK,EAAE,KAAK,CAAC,CAAC;YACtD,aAAa,CAAC,GAAG,CAAC,CAAC;QACrB,CAAC,CAAA,CAAC,CAAC;QAEH,EAAE,CAAC,mEAAmE,EAAE,GAAS,EAAE;YACjF,MAAM,CAAC,OAAO,EAAE,UAAU,CAAC,GAAG,MAAM,2BAAY,CAAC,iBAAiB,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;YACzE,MAAM,GAAG,GAAG,MAAM,qBAAqB,CAAC,OAAO,EAAE,UAAU,CAAC,CAAC;YAC7D,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YAChC,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,gBAAgB,CAAC,CAAC;YAChD,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,uBAAU,CAAC,IAAI,CAAC,4BAA4B,CAAC,IAAI,CAAC,CAAC;QACtF,CAAC,CAAA,CAAC,CAAC;QAEH,EAAE,CAAC,yDAAyD,EAAE,GAAS,EAAE;YACvE,MAAM,KAAK,GAAG,MAAM,2BAAY,CAAC,cAAc,EAAE,CAAC;YAClD,MAAM,UAAU,GAAG,MAAM,2BAAY,CAAC,gBAAgB,EAAE,CAAC;YACzD,MAAM,GAAG,GAAG,MAAM,qBAAqB,CAAC,KAAK,EAAE,UAAU,CAAC,CAAC;YAC3D,aAAa,CAAC,GAAG,CAAC,CAAC;QACrB,CAAC,CAAA,CAAC,CAAC;QAEH,EAAE,CAAC,yDAAyD,EAAE,GAAS,EAAE;YACvE,MAAM,KAAK,GAAG,MAAM,2BAAY,CAAC,cAAc,EAAE,CAAC;YAElD,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC;iBAChC,IAAI,CAAC,GAAG,QAAQ,YAAY,KAAK,CAAC,GAAG,EAAE,CAAC;iBACxC,GAAG,CAAC,QAAQ,EAAE,SAAS,mBAAQ,CAAC,aAAa,CAAC,KAAK,CAAC,EAAE,CAAC;iBACvD,MAAM,CAAC,MAAM,EAAE,EAAE,CAAC,YAAY,CAAC,iCAAiC,CAAC,EAAE,kBAAkB,CAAC,CAAC;YAE1F,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YAChC,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,gBAAgB,CAAC,CAAC;QAClD,CAAC,CAAA,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,UAAU,QAAQ,EAAE,EAAE,GAAG,EAAE;QAClC,SAAe,kBAAkB;;gBAC/B,MAAM,MAAM,GAAG,MAAM,2BAAY,CAAC,eAAe,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;gBACxD,MAAM,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC;gBAC9B,OAAO,MAAM,CAAC,CAAC,CAAC,CAAC;YACnB,CAAC;SAAA;QAED,EAAE,CAAC,sCAAsC,EAAE,GAAS,EAAE;YACpD,MAAM,KAAK,GAAG,MAAM,kBAAkB,EAAE,CAAC;YAEzC,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC;iBAChC,GAAG,CAAC,GAAG,QAAQ,IAAI,KAAK,CAAC,GAAG,EAAE,CAAC;iBAC/B,GAAG,CAAC,QAAQ,EAAE,SAAS,mBAAQ,CAAC,aAAa,CAAC,KAAK,CAAC,EAAE,CAAC;iBACvD,KAAK,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;YAE9B,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YAChC,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,iBAAiB,CAAC,CAAC;YACjD,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,uBAAU,CAAC,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC;QACvE,CAAC,CAAA,CAAC,CAAC;QAEH,EAAE,CAAC,kDAAkD,EAAE,GAAS,EAAE;YAChE,MAAM,OAAO,GAAG,MAAM,2BAAY,CAAC,gBAAgB,EAAE,CAAC;YACtD,MAAM,QAAQ,GAAG,MAAM,2BAAY,CAAC,gBAAgB,EAAE,CAAC;YACvD,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC;iBAChC,GAAG,CAAC,GAAG,QAAQ,IAAI,QAAQ,CAAC,GAAG,EAAE,CAAC;iBAClC,GAAG,CAAC,QAAQ,EAAE,SAAS,mBAAQ,CAAC,aAAa,CAAC,OAAO,CAAC,EAAE,CAAC;iBACzD,KAAK,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;YAE9B,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YAChC,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,iBAAiB,CAAC,CAAC;YACjD,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,uBAAU,CAAC,IAAI,CAAC,oBAAoB,CAAC,IAAI,CAAC,CAAC;QAC9E,CAAC,CAAA,CAAC,CAAC;QAEH,EAAE,CAAC,yEAAyE,EAAE,GAAS,EAAE;YACvF,MAAM,KAAK,GAAG,MAAM,kBAAkB,EAAE,CAAC;YACzC,MAAM,YAAY,GAAG,MAAM,2BAAY,CAAC,gBAAgB,EAAE,CAAC;YAC3D,EAAE,+BAA+B;gBAC/B,YAAY,CAAC,IAAI,GAAG,OAAO,CAAC;gBAE5B,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC;qBAChC,GAAG,CAAC,GAAG,QAAQ,IAAI,YAAY,CAAC,GAAG,EAAE,CAAC;qBACtC,GAAG,CAAC,QAAQ,EAAE,SAAS,mBAAQ,CAAC,aAAa,CAAC,KAAK,CAAC,EAAE,CAAC;qBACvD,IAAI,CAAC,YAAY,CAAC,CAAC;gBAEtB,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;gBAChC,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC;aACxC;YACD,EAAE,uBAAuB;gBACvB,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC;qBAChC,GAAG,CAAC,GAAG,QAAQ,IAAI,KAAK,CAAC,GAAG,EAAE,CAAC;qBAC/B,GAAG,CAAC,QAAQ,EAAE,SAAS,mBAAQ,CAAC,aAAa,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC;gBAE3D,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;aACjC;QACH,CAAC,CAAA,CAAC,CAAC;QAEH,EAAE,CAAC,4BAA4B,EAAE,GAAS,EAAE;YAC1C,MAAM,OAAO,GAAG,MAAM,2BAAY,CAAC,gBAAgB,EAAE,CAAC;YAEtD,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC;iBAChC,GAAG,CAAC,GAAG,QAAQ,IAAI,OAAO,CAAC,GAAG,EAAE,CAAC;iBACjC,GAAG,CAAC,QAAQ,EAAE,SAAS,mBAAQ,CAAC,aAAa,CAAC,OAAO,CAAC,EAAE,CAAC;iBACzD,KAAK,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;YAE9B,MAAM,iBAAiB,GAAG,WAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;YAErD,MAAM,CAAC,KAAK,CAAC,iBAAiB,EAAE,4BAA4B,CAAC,CAAC;YAE9D,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;QAClC,CAAC,CAAA,CAAC,CAAC;QAEH,EAAE,CAAC,yBAAyB,EAAE,GAAS,EAAE;YACvC,MAAM,KAAK,GAAG,MAAM,2BAAY,CAAC,cAAc,EAAE,CAAC;YAClD,MAAM,OAAO,GAAG,MAAM,2BAAY,CAAC,gBAAgB,EAAE,CAAC;YAEtD,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC;iBAChC,GAAG,CAAC,GAAG,QAAQ,IAAI,OAAO,CAAC,GAAG,EAAE,CAAC;iBACjC,GAAG,CAAC,QAAQ,EAAE,SAAS,mBAAQ,CAAC,aAAa,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC;YAE3D,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YAChC,GAAG,CAAC,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;QACxC,CAAC,CAAA,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC","file":"../../../test/integration/user.js","sourcesContent":["import * as chai from 'chai';\r\nimport * as request from 'superagent';\r\nimport {Server} from '../../src/server';\r\nimport {FixtureLoader} from '../../fixtures/FixtureLoader';\r\nimport {JwtUtils} from '../../src/security/JwtUtils';\r\nimport {User} from '../../src/models/User';\r\nimport {errorCodes} from '../../src/config/errorCodes';\r\nimport {FixtureUtils} from '../../fixtures/FixtureUtils';\r\nimport {IUser} from '../../../shared/models/IUser';\r\nimport {allRoles} from '../../src/config/roles';\r\nimport chaiHttp = require('chai-http');\r\nimport fs = require('fs');\r\n\r\nchai.use(chaiHttp);\r\nconst should = chai.should();\r\nconst app = new Server().app;\r\nconst BASE_URL = '/api/users';\r\nconst ROLE_URL = BASE_URL + '/roles';\r\nconst Search_URL = BASE_URL + '/members/search';\r\nconst fixtureLoader = new FixtureLoader();\r\n\r\ndescribe('User', () => {\r\n  // Before each test we reset the database\r\n  beforeEach(async () => {\r\n    await fixtureLoader.load();\r\n  });\r\n\r\n  describe(`GET ${BASE_URL}`, () => {\r\n    it('should return all users', async () => {\r\n      const teacher = await FixtureUtils.getRandomTeacher();\r\n\r\n      const res = await chai.request(app)\r\n        .get(BASE_URL)\r\n        .set('Cookie', `token=${JwtUtils.generateToken(teacher)}`);\r\n\r\n      res.status.should.be.equal(200);\r\n      res.body.should.be.a('array');\r\n      res.body.length.should.be.equal(await FixtureUtils.getUserCount());\r\n    });\r\n\r\n    it('should fail with wrong authorization', async () => {\r\n\r\n      const res = await chai.request(app)\r\n        .get(BASE_URL)\r\n        .set('Authorization', 'JWT asdf')\r\n        .catch(err => err.response);\r\n\r\n      res.status.should.be.equal(401);\r\n    });\r\n\r\n    it('should return the requested user object', async () => {\r\n      const admin = await FixtureUtils.getRandomAdmin();\r\n\r\n      const res = await chai.request(app)\r\n        .get(`${BASE_URL}/${admin._id}`)\r\n        .set('Cookie', `token=${JwtUtils.generateToken(admin)}`);\r\n\r\n      res.status.should.be.equal(200);\r\n      res.body._id.should.be.equal(admin._id.toString());\r\n      res.body.email.should.be.equal(admin.email);\r\n    });\r\n  });\r\n\r\n  describe(`GET ${ROLE_URL}`, () => {\r\n    it('should fail with permission denied', async () => {\r\n      const student = await FixtureUtils.getRandomStudent();\r\n\r\n      const res = await chai.request(app)\r\n        .get(ROLE_URL)\r\n        .set('Cookie', `token=${JwtUtils.generateToken(student)}`)\r\n        .catch(err => err.response);\r\n\r\n      res.status.should.be.equal(403);\r\n    });\r\n\r\n    it('should return an array with the defined roles', async () => {\r\n      const admin = await FixtureUtils.getRandomAdmin();\r\n\r\n      const res = await chai.request(app)\r\n        .get(ROLE_URL)\r\n        .set('Cookie', `token=${JwtUtils.generateToken(admin)}`);\r\n\r\n      res.status.should.be.equal(200);\r\n      res.body.should.be.a('array');\r\n      res.body.length.should.be.equal(allRoles.length);\r\n      res.body.should.have.same.members(allRoles);\r\n    });\r\n  });\r\n\r\n  describe(`GET ${Search_URL}`, () => {\r\n    it('should search for a student', async () => {\r\n      const teacher = await FixtureUtils.getRandomTeacher();\r\n      const newUser: IUser = new User({\r\n        uid: '487895',\r\n        email: 'test@local.tv',\r\n        password: 'test123456',\r\n        profile: {\r\n          firstName: 'Max',\r\n          lastName: 'Mustermann'\r\n        },\r\n        role: 'student'\r\n      });\r\n      const createdUser = await User.create(newUser);\r\n      const res = await chai.request(app)\r\n        .get(Search_URL)\r\n        .query({\r\n          role: newUser.role,\r\n          query: newUser.uid +\r\n          ' ' + newUser.email +\r\n          ' ' + newUser.profile.firstName +\r\n          ' ' + newUser.profile.lastName,\r\n          limit: 1\r\n        })\r\n        .set('Cookie', `token=${JwtUtils.generateToken(teacher)}`);\r\n\r\n      res.status.should.be.equal(200);\r\n      res.body.meta.count.should.be.greaterThan(0);\r\n      res.body.users.length.should.be.greaterThan(0);\r\n      res.body.users[0].profile.firstName.should.be.equal(newUser.profile.firstName);\r\n      res.body.users[0].profile.firstName.should.be.equal(newUser.profile.firstName);\r\n      res.body.users[0].uid.should.be.equal(newUser.uid);\r\n      res.body.users[0].email.should.be.equal(newUser.email);\r\n    });\r\n\r\n    it('should search for a teacher', async () => {\r\n      const teacher = await FixtureUtils.getRandomTeacher();\r\n      const newUser: IUser = new User({\r\n        uid: '487895',\r\n        email: 'test@local.tv',\r\n        password: 'test123456',\r\n        profile: {\r\n          firstName: 'Max',\r\n          lastName: 'Mustermann'\r\n        },\r\n        role: 'teacher'\r\n      });\r\n      const createdUser = await User.create(newUser);\r\n      const res = await chai.request(app)\r\n        .get(Search_URL)\r\n        .query({\r\n          role: 'teacher',\r\n          query: newUser.uid +\r\n          ' ' + newUser.email +\r\n          ' ' + newUser.profile.firstName +\r\n          ' ' + newUser.profile.lastName\r\n        })\r\n        .set('Cookie', `token=${JwtUtils.generateToken(teacher)}`);\r\n\r\n      res.status.should.be.equal(200);\r\n      res.body.meta.count.should.be.greaterThan(0);\r\n      res.body.users.length.should.be.greaterThan(0);\r\n      res.body.users[0].profile.firstName.should.be.equal(newUser.profile.firstName);\r\n      res.body.users[0].profile.firstName.should.be.equal(newUser.profile.firstName);\r\n      res.body.users[0].uid.should.be.equal(newUser.uid);\r\n      res.body.users[0].email.should.be.equal(newUser.email);\r\n    });\r\n  });\r\n\r\n  describe(`PUT ${BASE_URL}`, () => {\r\n    function requestUserUpdate(currentUser: IUser, updatedUser: IUser) {\r\n      return chai.request(app)\r\n        .put(`${BASE_URL}/${updatedUser._id}`)\r\n        .set('Cookie', `token=${JwtUtils.generateToken(currentUser)}`)\r\n        .send(updatedUser);\r\n    }\r\n\r\n    function requestUserUpdateAndCatch(currentUser: IUser, updatedUser: IUser) {\r\n      return requestUserUpdate(currentUser, updatedUser).catch(err => err.response);\r\n    }\r\n\r\n    function assertFailure(res: request.Response, status: number, name: string, message: string) {\r\n      res.status.should.be.equal(status);\r\n      res.body.name.should.be.equal(name);\r\n      res.body.message.should.be.equal(message);\r\n    }\r\n\r\n    it('should fail with bad request (revoke own admin privileges)', async () => {\r\n      const admin = await FixtureUtils.getRandomAdmin();\r\n      const updatedUser = admin;\r\n      updatedUser.role = 'teacher';\r\n\r\n      const res = await requestUserUpdateAndCatch(admin, updatedUser);\r\n      assertFailure(res, 400, 'BadRequestError', errorCodes.user.cantChangeOwnRole.text);\r\n    });\r\n\r\n    it('should fail with bad request (email already in use)', async () => {\r\n      const admin = await FixtureUtils.getRandomAdmin();\r\n      const updatedUser = await FixtureUtils.getRandomStudent();\r\n      updatedUser.email = admin.email;\r\n\r\n      const res = await requestUserUpdateAndCatch(admin, updatedUser);\r\n      assertFailure(res, 400, 'BadRequestError', errorCodes.user.emailAlreadyInUse.text);\r\n    });\r\n\r\n    // This test is disabled because there currently is no role beneath 'admin' that is allowed to edit other users.\r\n    // Reactivate and adjust this test if such a role should become available in the future.\r\n    // (Previously teachers had permission to change some parts of any student's profile.)\r\n    /*\r\n    it('should fail changing other user\\'s uid with wrong authorization (not admin)', async () => {\r\n      const teacher = await FixtureUtils.getRandomTeacher();\r\n      const updatedUser = await FixtureUtils.getRandomStudent();\r\n      updatedUser.uid = '987456';\r\n\r\n      const res = await requestUserUpdateAndCatch(teacher, updatedUser);\r\n      assertFailure(res, 403, 'ForbiddenError', errorCodes.user.onlyAdminsCanChangeUids.text);\r\n    });\r\n    */\r\n\r\n    it('should fail changing other user\\'s name with wrong authorization (low edit level)', async () => {\r\n      const [student, updatedUser] = await FixtureUtils.getRandomStudents(2, 2);\r\n      updatedUser.profile.firstName = 'TEST';\r\n\r\n      const res = await requestUserUpdateAndCatch(student, updatedUser);\r\n      assertFailure(res, 403, 'ForbiddenError', errorCodes.user.cantChangeUserWithHigherRole.text);\r\n    });\r\n\r\n    it('should update user base data without password', async () => {\r\n      const student = await FixtureUtils.getRandomStudent();\r\n      const updatedUser = student;\r\n      updatedUser.password = undefined;\r\n      updatedUser.profile.firstName = 'Updated';\r\n      updatedUser.profile.lastName = 'User';\r\n      updatedUser.email = 'student2@updated.local';\r\n\r\n      const res = await requestUserUpdate(student, updatedUser);\r\n      res.status.should.be.equal(200);\r\n      res.body.profile.firstName.should.be.equal('Updated');\r\n      res.body.profile.lastName.should.be.equal('User');\r\n      res.body.email.should.be.equal('student2@updated.local');\r\n    });\r\n\r\n    it('should update user data', async () => {\r\n      const student = await FixtureUtils.getRandomStudent();\r\n      const updatedUser = student;\r\n      updatedUser.password = '';\r\n      updatedUser.profile.firstName = 'Updated';\r\n      updatedUser.profile.lastName = 'User';\r\n      updatedUser.email = 'student1@updated.local';\r\n\r\n      const res = await requestUserUpdate(student, updatedUser);\r\n      res.status.should.be.equal(200);\r\n      res.body.profile.firstName.should.be.equal('Updated');\r\n      res.body.profile.lastName.should.be.equal('User');\r\n      res.body.email.should.be.equal('student1@updated.local');\r\n    });\r\n\r\n    it('should update user base data without password', async () => {\r\n      const student = await FixtureUtils.getRandomStudent();\r\n      const updatedUser = student;\r\n      updatedUser.password = undefined;\r\n      updatedUser.profile.firstName = 'Updated';\r\n      updatedUser.profile.lastName = 'User';\r\n      updatedUser.email = 'student@updated.local';\r\n\r\n      const res = await requestUserUpdate(student, updatedUser);\r\n      res.status.should.be.equal(200);\r\n      res.body.profile.firstName.should.be.equal('Updated');\r\n      res.body.profile.lastName.should.be.equal('User');\r\n      res.body.email.should.be.equal('student@updated.local');\r\n    });\r\n\r\n    it('should keep a existing uid', async () => {\r\n      const admin = await FixtureUtils.getRandomAdmin();\r\n      const student = await FixtureUtils.getRandomStudent();\r\n      const origUid = student.uid;\r\n      const updatedUser = student;\r\n      updatedUser.uid = null;\r\n      updatedUser.password = '';\r\n      updatedUser.profile.firstName = 'Updated';\r\n      updatedUser.profile.lastName = 'User';\r\n      updatedUser.email = 'student@updated.local';\r\n\r\n      const res = await requestUserUpdate(admin, updatedUser);\r\n      res.status.should.be.equal(200);\r\n      res.body.uid.should.be.equal(origUid);\r\n      res.body.profile.firstName.should.be.equal('Updated');\r\n      res.body.profile.lastName.should.be.equal('User');\r\n      res.body.email.should.be.equal('student@updated.local');\r\n    });\r\n  });\r\n\r\n  describe(`POST ${BASE_URL}/picture`, () => {\r\n    async function requestAddUserPicture(currentUser: IUser, targetUser: IUser) {\r\n      return await chai.request(app)\r\n        .post(`${BASE_URL}/picture/${targetUser._id}`)\r\n        .set('Cookie', `token=${JwtUtils.generateToken(currentUser)}`)\r\n        .attach('file', fs.readFileSync('test/resources/test.png'), 'test.png');\r\n    }\r\n\r\n    function assertSuccess(res: request.Response) {\r\n      res.status.should.be.equal(200);\r\n      res.body.profile.picture.should.be.an('object');\r\n      res.body.profile.picture.should.have.all.keys('alias', 'name', 'path');\r\n      res.body.profile.picture.alias.should.be.equal('test.png');\r\n    }\r\n\r\n    it('should upload a new user picture', async () => {\r\n      const admin = await FixtureUtils.getRandomAdmin();\r\n      const res = await requestAddUserPicture(admin, admin);\r\n      assertSuccess(res);\r\n    });\r\n\r\n    it('should fail to upload a new picture for another user (as student)', async () => {\r\n      const [student, targetUser] = await FixtureUtils.getRandomStudents(2, 2);\r\n      const res = await requestAddUserPicture(student, targetUser);\r\n      res.status.should.be.equal(403);\r\n      res.body.name.should.be.equal('ForbiddenError');\r\n      res.body.message.should.be.equal(errorCodes.user.cantChangeUserWithHigherRole.text);\r\n    });\r\n\r\n    it('should upload a new picture for another user (as admin)', async () => {\r\n      const admin = await FixtureUtils.getRandomAdmin();\r\n      const targetUser = await FixtureUtils.getRandomStudent();\r\n      const res = await requestAddUserPicture(admin, targetUser);\r\n      assertSuccess(res);\r\n    });\r\n\r\n    it('should block non images when uploading new user picture', async () => {\r\n      const admin = await FixtureUtils.getRandomAdmin();\r\n\r\n      const res = await chai.request(app)\r\n        .post(`${BASE_URL}/picture/${admin._id}`)\r\n        .set('Cookie', `token=${JwtUtils.generateToken(admin)}`)\r\n        .attach('file', fs.readFileSync('test/resources/wrong-format.rtf'), 'wrong-format.txt');\r\n\r\n      res.status.should.be.equal(403);\r\n      res.body.name.should.be.equal('ForbiddenError');\r\n    });\r\n  });\r\n\r\n  describe(`DELETE ${BASE_URL}`, () => {\r\n    async function ensureOnlyOneAdmin() {\r\n      const admins = await FixtureUtils.getRandomAdmins(1, 2);\r\n      admins.length.should.be.eq(1);\r\n      return admins[0];\r\n    }\r\n\r\n    it('should fail to delete the only admin', async () => {\r\n      const admin = await ensureOnlyOneAdmin();\r\n\r\n      const res = await chai.request(app)\r\n        .del(`${BASE_URL}/${admin._id}`)\r\n        .set('Cookie', `token=${JwtUtils.generateToken(admin)}`)\r\n        .catch(err => err.response);\r\n\r\n      res.status.should.be.equal(400);\r\n      res.body.name.should.be.equal('BadRequestError');\r\n      res.body.message.should.be.equal(errorCodes.user.noOtherAdmins.text);\r\n    });\r\n\r\n    it('should fail to delete another user, if not admin', async () => {\r\n      const teacher = await FixtureUtils.getRandomTeacher();\r\n      const studtent = await FixtureUtils.getRandomStudent();\r\n      const res = await chai.request(app)\r\n        .del(`${BASE_URL}/${studtent._id}`)\r\n        .set('Cookie', `token=${JwtUtils.generateToken(teacher)}`)\r\n        .catch(err => err.response);\r\n\r\n      res.status.should.be.equal(400);\r\n      res.body.name.should.be.equal('BadRequestError');\r\n      res.body.message.should.be.equal(errorCodes.user.cantDeleteOtherUsers.text);\r\n    });\r\n\r\n    it('should (promote a teacher to admin and) let the old admin delete itself', async () => {\r\n      const admin = await ensureOnlyOneAdmin();\r\n      const promotedUser = await FixtureUtils.getRandomTeacher();\r\n      { // Promote the teacher to admin\r\n        promotedUser.role = 'admin';\r\n\r\n        const res = await chai.request(app)\r\n          .put(`${BASE_URL}/${promotedUser._id}`)\r\n          .set('Cookie', `token=${JwtUtils.generateToken(admin)}`)\r\n          .send(promotedUser);\r\n\r\n        res.status.should.be.equal(200);\r\n        res.body.role.should.be.equal('admin');\r\n      }\r\n      { // Delete the old admin\r\n        const res = await chai.request(app)\r\n          .del(`${BASE_URL}/${admin._id}`)\r\n          .set('Cookie', `token=${JwtUtils.generateToken(admin)}`);\r\n\r\n        res.status.should.be.equal(200);\r\n      }\r\n    });\r\n\r\n    it('should send delete request', async () => {\r\n      const teacher = await FixtureUtils.getRandomTeacher();\r\n\r\n      const res = await chai.request(app)\r\n        .del(`${BASE_URL}/${teacher._id}`)\r\n        .set('Cookie', `token=${JwtUtils.generateToken(teacher)}`)\r\n        .catch(err => err.response);\r\n\r\n      const userDeleteRequest = User.findById(teacher._id);\r\n\r\n      should.exist(userDeleteRequest, 'User doesnt exist anymore.');\r\n\r\n      res.status.should.be.equal(200);\r\n    });\r\n\r\n    it('should delete a student', async () => {\r\n      const admin = await FixtureUtils.getRandomAdmin();\r\n      const student = await FixtureUtils.getRandomStudent();\r\n\r\n      const res = await chai.request(app)\r\n        .del(`${BASE_URL}/${student._id}`)\r\n        .set('Cookie', `token=${JwtUtils.generateToken(admin)}`);\r\n\r\n      res.status.should.be.equal(200);\r\n      res.body.result.should.be.equal(true);\r\n    });\r\n  });\r\n});\r\n"]}