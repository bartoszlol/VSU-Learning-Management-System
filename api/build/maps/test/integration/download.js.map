{"version":3,"sources":["test/integration/download.ts"],"names":[],"mappings":"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","file":"../../../test/integration/download.js","sourcesContent":["import * as chai from 'chai';\r\nimport {Server} from '../../src/server';\r\nimport {FixtureLoader} from '../../fixtures/FixtureLoader';\r\nimport {JwtUtils} from '../../src/security/JwtUtils';\r\nimport {User} from '../../src/models/User';\r\nimport {FixtureUtils} from '../../fixtures/FixtureUtils';\r\nimport {IDownload} from '../../../shared/models/IDownload';\r\nimport {IUser} from '../../../shared/models/IUser';\r\nimport {Lecture} from '../../src/models/Lecture';\r\nimport {ICourse} from '../../../shared/models/ICourse';\r\nimport chaiHttp = require('chai-http');\r\n\r\nchai.use(chaiHttp);\r\nconst should = chai.should();\r\nconst expect = chai.expect;\r\n\r\nconst app = new Server().app;\r\nconst BASE_URL = '/api/download';\r\nconst fixtureLoader = new FixtureLoader();\r\n\r\n/**\r\n * Prepare test data\r\n * @param course\r\n */\r\nasync function prepareTestData(course: ICourse) {\r\n  const lectures: any[] = [];\r\n  for (const lectureId of course.lectures) {\r\n    const lecture = await Lecture.findById(lectureId);\r\n    const units: any[] = [];\r\n    for (const unitId of lecture.units) {\r\n      units.push({unitId});\r\n    }\r\n    lectures.push({lectureId, units});\r\n  }\r\n  return {\r\n    'courseName': course._id,\r\n    'lectures': lectures\r\n  };\r\n}\r\n\r\ndescribe('DownloadFile', () => {\r\n  // Before each test we reset the database\r\n  beforeEach(async () => {\r\n    await fixtureLoader.load();\r\n  });\r\n\r\n  after(async () => {\r\n    await requestValidCleanup();\r\n  });\r\n\r\n  async function postValidRequest() {\r\n    let unit = null;\r\n    while (unit === null) {\r\n      unit = await FixtureUtils.getRandomUnit();\r\n      if (unit.__t === 'assignment') {\r\n         unit = null;\r\n      }\r\n    }\r\n    const lecture = await FixtureUtils.getLectureFromUnit(unit);\r\n    const course = await FixtureUtils.getCourseFromLecture(lecture);\r\n    const courseAdmin = await User.findById(course.courseAdmin);\r\n    const downloadRequestData: IDownload = {\r\n      courseName: course._id,\r\n      lectures: [{lectureId: lecture._id, units: [{unitId: unit._id}]}]\r\n    };\r\n\r\n    const res = await chai.request(app)\r\n      .post(BASE_URL + '/pdf/single')\r\n      .set('Cookie', `token=${JwtUtils.generateToken(courseAdmin)}`)\r\n      .send(downloadRequestData)\r\n      .catch(err => err.response);\r\n    res.status.should.be.equal(200);\r\n    return {postRes: res, courseAdmin};\r\n  }\r\n\r\n  function requestCleanup(user: IUser) {\r\n    return chai.request(app)\r\n      .del(BASE_URL + '/cache')\r\n      .set('Cookie', `token=${JwtUtils.generateToken(user)}`)\r\n      .catch(err => err.response);\r\n  }\r\n\r\n  async function requestValidCleanup() {\r\n    const admin = await FixtureUtils.getRandomAdmin();\r\n    const res = await requestCleanup(admin);\r\n    res.status.should.be.equal(200);\r\n  }\r\n\r\n  describe(`GET ${BASE_URL}`, () => {\r\n    it('should succeed for some valid input with prior POST', async () => {\r\n      const {postRes, courseAdmin} = await postValidRequest();\r\n      postRes.body.should.not.be.empty;\r\n\r\n      const res = await chai.request(app)\r\n        .get(BASE_URL + '/' + postRes.body)\r\n        .set('Cookie', `token=${JwtUtils.generateToken(courseAdmin)}`)\r\n        .catch(err => err.response);\r\n      res.status.should.be.equal(200);\r\n    });\r\n\r\n    it('should fail, malignant file id', async () => {\r\n      const {postRes, courseAdmin} = await postValidRequest();\r\n      postRes.body.should.not.be.empty;\r\n\r\n      const res = await chai.request(app)\r\n        .get(BASE_URL + '/%2E%2E%2F' + postRes.body)\r\n        .set('Cookie', `token=${JwtUtils.generateToken(courseAdmin)}`)\r\n        .catch(err => err.response);\r\n      res.status.should.be.equal(403);\r\n    });\r\n\r\n    it('should fail, no auth', async () => {\r\n\r\n      const res = await chai.request(app)\r\n        .get(BASE_URL + '/123456789')\r\n        .set('Authorization', 'JWT asdf')\r\n        .catch(err => err.response);\r\n      res.status.should.be.equal(401);\r\n    });\r\n\r\n    it('should fail, no hash with that id', async () => {\r\n      const teacher = await FixtureUtils.getRandomTeacher();\r\n\r\n      const res = await chai.request(app)\r\n        .get(BASE_URL + '/123456789')\r\n        .set('Cookie', `token=${JwtUtils.generateToken(teacher)}`)\r\n        .catch(err => err.response);\r\n      res.status.should.be.equal(404);\r\n    });\r\n  });\r\n\r\n  describe(`POST ${BASE_URL + '/pdf/individual'}`, () => {\r\n    it('should fail, no auth', async () => {\r\n      const res = await chai.request(app)\r\n        .post(BASE_URL + '/pdf/individual')\r\n        .set('Authorization', 'JWT asdf')\r\n        .catch(err => err.response);\r\n      res.status.should.be.equal(401);\r\n    });\r\n    it('should fail, course does not exists', async () => {\r\n      const course = await FixtureUtils.getRandomCourse();\r\n      const teacher = await User.findById(course.courseAdmin);\r\n      const testData: IDownload = {\r\n        courseName: '000000000000000000000000',\r\n        'lectures': [{\r\n          'lectureId': '000000000000000000000000',\r\n          'units': [{'unitId': '000000000000000000000000'}]\r\n        }]\r\n      };\r\n      const res = await chai.request(app)\r\n        .post(BASE_URL + '/pdf/individual')\r\n        .set('Cookie', `token=${JwtUtils.generateToken(teacher)}`)\r\n        .send(testData)\r\n        .catch(err => err.response);\r\n      res.status.should.be.equal(404);\r\n    });\r\n    it('should fail, because user is not in course', async () => {\r\n      const course = await FixtureUtils.getRandomCourse();\r\n      const teacher = await User.findById(course.courseAdmin);\r\n      const user = await User.findOne().where('_id').ne(teacher._id);\r\n      const testData: IDownload = {\r\n        courseName: course._id,\r\n        'lectures': [{\r\n          'lectureId': '000000000000000000000000',\r\n          'units': [{'unitId': '000000000000000000000000'}]\r\n        }]\r\n      };\r\n      const res = await chai.request(app)\r\n        .post(BASE_URL + '/pdf/individual')\r\n        .set('Cookie', `token=${JwtUtils.generateToken(user)}`)\r\n        .send(testData)\r\n        .catch(err => err.response);\r\n      res.status.should.be.equal(404);\r\n    });\r\n    it('should fail, because the lectures is empty and the IDownloadObject cant be created', async () => {\r\n      const course = await FixtureUtils.getRandomCourse();\r\n      const teacher = await User.findById(course.courseAdmin);\r\n      const testData = {\r\n        courseName: course._id,\r\n        lectures: Array,\r\n      };\r\n      const res = await chai.request(app)\r\n        .post(BASE_URL + '/pdf/individual')\r\n        .set('Cookie', `token=${JwtUtils.generateToken(teacher)}`)\r\n        .send(testData)\r\n        .catch(err => err.response);\r\n      res.status.should.be.equal(500);\r\n    });\r\n    it('should pass (teacher)', async () => {\r\n      const course = await FixtureUtils.getRandomCourseWithAllUnitTypes();\r\n      const teacher = await FixtureUtils.getRandomTeacherForCourse(course);\r\n      const testData = await prepareTestData(course);\r\n      const res = await chai.request(app)\r\n        .post(BASE_URL + '/pdf/individual')\r\n        .set('Cookie', `token=${JwtUtils.generateToken(teacher)}`)\r\n        .send(testData)\r\n        .catch(err => err.response);\r\n      expect(res).to.have.status(200);\r\n      expect(res).to.be.json;\r\n    }).timeout(45000);\r\n    it('should pass (student)', async () => {\r\n      const course = await FixtureUtils.getRandomCourseWithAllUnitTypes();\r\n      const student = await FixtureUtils.getRandomStudentForCourse(course);\r\n      const testData = await prepareTestData(course);\r\n      const res = await chai.request(app)\r\n        .post(BASE_URL + '/pdf/individual')\r\n        .set('Cookie', `token=${JwtUtils.generateToken(student)}`)\r\n        .send(testData)\r\n        .catch(err => err.response);\r\n      expect(res).to.have.status(200);\r\n      expect(res).to.be.json;\r\n    }).timeout(45000);\r\n  });\r\n\r\n  describe(`POST ${BASE_URL + '/pdf/single'}`, () => {\r\n    it('should succeed for some valid input', async () => {\r\n      await postValidRequest();\r\n    });\r\n\r\n    it('should fail, no auth', async () => {\r\n\r\n      const res = await chai.request(app)\r\n        .post(BASE_URL + '/pdf/single')\r\n        .set('Authorization', 'JWT asdf')\r\n        .catch(err => err.response);\r\n      res.status.should.be.equal(401);\r\n    });\r\n\r\n    it('should fail, course does not exists', async () => {\r\n      const course = await FixtureUtils.getRandomCourse();\r\n      const teacher = await User.findById(course.courseAdmin);\r\n\r\n      const testData: IDownload = {\r\n        courseName: '000000000000000000000000',\r\n        'lectures': [{\r\n          'lectureId': '000000000000000000000000',\r\n          'units': [{'unitId': '000000000000000000000000'}]\r\n        }]\r\n      };\r\n\r\n      const res = await chai.request(app)\r\n        .post(BASE_URL + '/pdf/single')\r\n        .set('Cookie', `token=${JwtUtils.generateToken(teacher)}`)\r\n        .send(testData)\r\n        .catch(err => err.response);\r\n      res.status.should.be.equal(404);\r\n    });\r\n\r\n    it('should fail, because user is not in course', async () => {\r\n      const course = await FixtureUtils.getRandomCourse();\r\n      const teacher = await User.findById(course.courseAdmin);\r\n      const user = await User.findOne().where('_id').ne(teacher._id);\r\n\r\n      const testData: IDownload = {\r\n        courseName: course._id,\r\n        'lectures': [{\r\n          'lectureId': '000000000000000000000000',\r\n          'units': [{'unitId': '000000000000000000000000'}]\r\n        }]\r\n      };\r\n\r\n      const res = await chai.request(app)\r\n        .post(BASE_URL + '/pdf/single')\r\n        .set('Cookie', `token=${JwtUtils.generateToken(user)}`)\r\n        .send(testData)\r\n        .catch(err => err.response);\r\n      res.status.should.be.equal(404);\r\n    });\r\n\r\n    it('should fail, because the lectures is empty and the IDownloadObject cant be created', async () => {\r\n      const course = await FixtureUtils.getRandomCourse();\r\n      const teacher = await User.findById(course.courseAdmin);\r\n\r\n      const testData = {\r\n        courseName: course._id,\r\n        'lectures': Array\r\n      };\r\n\r\n      const res = await chai.request(app)\r\n        .post(BASE_URL + '/pdf/single')\r\n        .set('Cookie', `token=${JwtUtils.generateToken(teacher)}`)\r\n        .send(testData)\r\n        .catch(err => err.response);\r\n      res.status.should.be.equal(500);\r\n    });\r\n  });\r\n\r\n  describe(`DELETE ${BASE_URL}/cache`, () => {\r\n    it('should succeed with admin as user', async () => {\r\n      await requestValidCleanup();\r\n    });\r\n\r\n    it('should fail with non-admin as user', async () => {\r\n      const student = await FixtureUtils.getRandomStudent();\r\n      const res = await requestCleanup(student);\r\n      res.status.should.be.equal(403);\r\n    });\r\n  });\r\n});\r\n\r\n"]}