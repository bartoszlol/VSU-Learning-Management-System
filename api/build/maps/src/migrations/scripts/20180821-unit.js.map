{"version":3,"sources":["src/migrations/scripts/20180821-unit.ts"],"names":[],"mappings":";;;;;;;;;AAAA,4BAA4B;AAC5B,qCAAqC;AACrC,kDAAyD;AACzD,oDAA+C;AAE/C,MAAM,eAAe;IAEb,EAAE;;YACN,OAAO,CAAC,GAAG,CAAC,uBAAuB,CAAC,CAAC;YACrC,IAAI;gBACF,MAAM,KAAK,GAAiB,MAAM,WAAI,CAAC,IAAI,CAAC,EAAC,UAAU,EAAE,EAAC,OAAO,EAAE,KAAK,EAAC,EAAC,CAAC,CAAC;gBAC5E,MAAM,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,CAAO,IAAgB,EAAE,EAAE;oBACrD,MAAM,OAAO,GAAG,IAAI,CAAC,QAAQ,EAAE,CAAC;oBAChC,MAAM,QAAQ,GAAG,MAAM,mBAAQ,CAAC,MAAM,CAAC;wBACrC,IAAI,EAAE;4BACJ,QAAQ,EAAE,MAAM;4BAChB,OAAO,EAAE,IAAI,CAAC,GAAG;yBAClB;qBACF,CAAC,CAAC;oBACH,MAAM,WAAW,GAAG,QAAQ,CAAC,QAAQ,EAAE,CAAC;oBAExC,OAAO,CAAC,QAAQ,GAAG,WAAW,CAAC,GAAG,CAAC;oBACnC,OAAO,CAAC,GAAG,GAAG,QAAQ,CAAC,KAAK,CAAC,QAAQ,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;oBAEnD,MAAM,QAAQ,CAAC,UAAU,CAAC,UAAU,CAAC,OAAO,CAAC;yBAC1C,iBAAiB,CAAC,EAAC,KAAK,EAAE,IAAI,CAAC,GAAG,EAAC,EAAE,OAAO,CAAC,CAAC;gBACnD,CAAC,CAAA,CAAC,CAAC,CAAC;aACL;YAAC,OAAO,KAAK,EAAE;gBACd,OAAO,CAAC,GAAG,CAAC,KAAK,GAAG,KAAK,CAAC,CAAC;aAC5B;YAED,OAAO,CAAC,GAAG,CAAC,mDAAmD,CAAC,CAAC;YACjE,OAAO,IAAI,CAAC;QACd,CAAC;KAAA;CACF;AAED,iBAAS,eAAe,CAAC","file":"../../../../src/migrations/scripts/20180821-unit.js","sourcesContent":["// tslint:disable:no-console\r\nimport * as mongoose from 'mongoose';\r\nimport {IUnitModel, Unit} from '../../models/units/Unit';\r\nimport {ChatRoom} from '../../models/ChatRoom';\r\n\r\nclass UnitV2Migration {\r\n\r\n  async up() {\r\n    console.log('Unit V2 up was called');\r\n    try {\r\n      const units: IUnitModel[] = await Unit.find({'chatRoom': {$exists: false}});\r\n      await Promise.all(units.map(async (unit: IUnitModel) => {\r\n        const unitObj = unit.toObject();\r\n        const chatRoom = await ChatRoom.create({\r\n          room: {\r\n            roomType: 'Unit',\r\n            roomFor: unit._id\r\n          }\r\n        });\r\n        const chatRoomObj = chatRoom.toObject();\r\n\r\n        unitObj.chatRoom = chatRoomObj._id;\r\n        unitObj._id = mongoose.Types.ObjectId(unitObj._id);\r\n\r\n        await mongoose.connection.collection('units')\r\n          .findOneAndReplace({'_id': unit._id}, unitObj);\r\n      }));\r\n    } catch (error) {\r\n      console.log('1: ' + error);\r\n    }\r\n\r\n    console.log('Chat rooms have been successfully added to units!');\r\n    return true;\r\n  }\r\n}\r\n\r\nexport = UnitV2Migration;\r\n"]}