{"version":3,"sources":["src/migrations/scripts/20180102-unit.ts"],"names":[],"mappings":";;;;;;;;;AAAA,4BAA4B;AAC5B,qCAAqC;AAIrC,MAAM,UAAU,GAAG,IAAI,QAAQ,CAAC,MAAM,CAAC;IACnC,OAAO,EAAE;QACP,IAAI,EAAE,QAAQ,CAAC,MAAM,CAAC,KAAK,CAAC,QAAQ;QACpC,GAAG,EAAE,QAAQ;KACd;IACD,IAAI,EAAE;QACJ,IAAI,EAAE,MAAM;QACZ,QAAQ,EAAE,IAAI;KACf;IACD,WAAW,EAAE;QACX,IAAI,EAAE,MAAM;KACb;IACD,YAAY,EAAE;QACZ,IAAI,EAAE,OAAO;KACd;IACD,MAAM,EAAE;QACN,IAAI,EAAE,MAAM;KACb;CACF,EACD;IACE,UAAU,EAAE,OAAO;IACnB,UAAU,EAAE,IAAI;IAChB,QAAQ,EAAE;QACR,SAAS,EAAE,UAAU,GAAe,EAAE,GAAQ;YAC5C,GAAG,CAAC,GAAG,GAAG,GAAG,CAAC,GAAG,CAAC,QAAQ,EAAE,CAAC;YAC7B,GAAG,CAAC,OAAO,GAAG,GAAG,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAC;QACvC,CAAC;KACF;CACF,CACF,CAAC;AAEF,MAAM,IAAI,GAAG,QAAQ,CAAC,KAAK,CAAa,SAAS,EAAE,UAAU,CAAC,CAAC;AAE/D,MAAM,aAAa;IAEX,EAAE;;YACN,OAAO,CAAC,GAAG,CAAC,oBAAoB,CAAC,CAAC;YAClC,IAAI;gBACF,MAAM,QAAQ,GAAiB,MAAM,IAAI,CAAC,IAAI,CAAC,EAAC,KAAK,EAAE,EAAC,OAAO,EAAE,KAAK,EAAC,EAAC,CAAC,CAAC;gBAC1E,MAAM,eAAe,GAAY,MAAM,OAAO,CAAC,GAAG,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAO,OAAmB,EAAE,EAAE;oBAC5F,MAAM,UAAU,GAAiB,OAAO,CAAC,QAAQ,EAAE,CAAC;oBACpD,UAAU,CAAC,GAAG,GAAG,UAAU,CAAC,IAAI,CAAC;oBAEjC,OAAO,UAAU,CAAC;gBACpB,CAAC,CAAA,CAAC,CAAC,CAAC;gBAEJ,MAAM,YAAY,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAO,OAAO,EAAE,EAAE;oBACpE,MAAM,cAAc,GAAG,eAAe,CAAC,IAAI,CAAC,CAAC,WAAkB,EAAE,EAAE;wBACjE,OAAO,WAAW,CAAC,GAAG,KAAK,OAAO,CAAC,GAAG,CAAC,QAAQ,EAAE,CAAC;oBACpD,CAAC,CAAC,CAAC;oBAEH,cAAc,CAAC,GAAG,GAAG,QAAQ,CAAC,KAAK,CAAC,QAAQ,CAAC,cAAc,CAAC,GAAG,CAAC,CAAC;oBAEjE,MAAM,gBAAgB,GAAG,MAAM,QAAQ,CAAC,UAAU,CAAC,UAAU,CAAC,OAAO,CAAC;yBACnE,iBAAiB,CAAC,EAAC,KAAK,EAAE,OAAO,CAAC,GAAG,EAAC,EAAE,cAAc,CAAC,CAAC;gBAC7D,CAAC,CAAA,CAAC,CAAC,CAAC;aACL;YAAC,OAAO,KAAK,EAAE;gBACd,OAAO,CAAC,GAAG,CAAC,KAAK,GAAG,KAAK,CAAC,CAAC;aAC5B;YAED,OAAO,CAAC,GAAG,CAAC,uCAAuC,CAAC,CAAC;YACrD,OAAO,IAAI,CAAC;QACd,CAAC;KAAA;IAED,IAAI;QACF,OAAO,CAAC,GAAG,CAAC,sBAAsB,CAAC,CAAC;IACtC,CAAC;CACF;AAED,iBAAS,aAAa,CAAC","file":"../../../../src/migrations/scripts/20180102-unit.js","sourcesContent":["// tslint:disable:no-console\r\nimport * as mongoose from 'mongoose';\r\nimport {IUnit} from '../../../../shared/models/units/IUnit';\r\nimport {IUnitModel} from '../../models/units/Unit';\r\n\r\nconst unitSchema = new mongoose.Schema({\r\n    _course: {\r\n      type: mongoose.Schema.Types.ObjectId,\r\n      ref: 'Course'\r\n    },\r\n    name: {\r\n      type: String,\r\n      required: true\r\n    },\r\n    description: {\r\n      type: String\r\n    },\r\n    progressable: {\r\n      type: Boolean\r\n    },\r\n    weight: {\r\n      type: Number\r\n    }\r\n  },\r\n  {\r\n    collection: 'units',\r\n    timestamps: true,\r\n    toObject: {\r\n      transform: function (doc: IUnitModel, ret: any) {\r\n        ret._id = doc._id.toString();\r\n        ret._course = ret._course.toString();\r\n      }\r\n    },\r\n  }\r\n);\r\n\r\nconst Unit = mongoose.model<IUnitModel>('NewUnit', unitSchema);\r\n\r\nclass UnitMigration {\r\n\r\n  async up() {\r\n    console.log('Unit up was called');\r\n    try {\r\n      const oldUnits: IUnitModel[] = await Unit.find({'__t': {$exists: false}});\r\n      const updatedUnitObjs: IUnit[] = await Promise.all(oldUnits.map(async (oldUnit: IUnitModel) => {\r\n        const oldUnitObj: IUnit = <IUnit>oldUnit.toObject();\r\n        oldUnitObj.__t = oldUnitObj.type;\r\n\r\n        return oldUnitObj;\r\n      }));\r\n\r\n      const updatedUnits = await Promise.all(oldUnits.map(async (oldUnit) => {\r\n        const updatedUnitObj = updatedUnitObjs.find((updatedUnit: IUnit) => {\r\n          return updatedUnit._id === oldUnit._id.toString();\r\n        });\r\n\r\n        updatedUnitObj._id = mongoose.Types.ObjectId(updatedUnitObj._id);\r\n\r\n        const unitAfterReplace = await mongoose.connection.collection('units')\r\n          .findOneAndReplace({'_id': oldUnit._id}, updatedUnitObj);\r\n      }));\r\n    } catch (error) {\r\n      console.log('1: ' + error);\r\n    }\r\n\r\n    console.log('Unit documents successfully migrated!');\r\n    return true;\r\n  }\r\n\r\n  down() {\r\n    console.log('Unit down was called');\r\n  }\r\n}\r\n\r\nexport = UnitMigration;\r\n"]}