{"version":3,"sources":["src/models/units/CodeKataUnit.ts"],"names":[],"mappings":"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","file":"../../../../src/models/units/CodeKataUnit.js","sourcesContent":["import * as mongoose from 'mongoose';\r\nimport {IUnitModel} from './Unit';\r\nimport {ICodeKataUnit} from '../../../../shared/models/units/ICodeKataUnit';\r\nimport {NativeError} from 'mongoose';\r\nimport {BadRequestError} from 'routing-controllers';\r\nimport {IUser} from '../../../../shared/models/IUser';\r\nconst MarkdownIt = require('markdown-it');\r\n\r\ninterface ICodeKataModel extends ICodeKataUnit, IUnitModel {\r\n  exportJSON: () => Promise<ICodeKataUnit>;\r\n  calculateProgress: () => Promise<ICodeKataUnit>;\r\n  secureData: (user: IUser) => Promise<ICodeKataModel>;\r\n}\r\n\r\nconst codeKataSchema = new mongoose.Schema({\r\n  definition: {\r\n    type: String,\r\n    required: [true, 'A Kata must contain a definition area']\r\n  },\r\n  code: {\r\n    type: String,\r\n    required: [true, 'A Kata must contain a code area']\r\n  },\r\n  test: {\r\n    type: String,\r\n    required: [true, 'A Kata must contain a test area']\r\n  },\r\n  deadline: {\r\n    type: String\r\n  },\r\n});\r\n\r\ncodeKataSchema.methods.secureData = async function (user: IUser): Promise<ICodeKataModel> {\r\n  if (user.role === 'student') {\r\n    this.code = null;\r\n  }\r\n\r\n  return this;\r\n};\r\n\r\nfunction splitCodeAreas(next: (err?: NativeError) => void) {\r\n  const codeKataUnit: ICodeKataModel = this;\r\n\r\n  if (codeKataUnit.definition !== undefined || codeKataUnit.test !== undefined || codeKataUnit.code === undefined) {\r\n    return next();\r\n  }\r\n\r\n  const separator = '\\/\\/#+';\r\n  const firstSeparator: number = findFirstIndexOf(codeKataUnit.code, separator);\r\n  const lastSeparator: number = findLastIndexOf(codeKataUnit.code, separator);\r\n\r\n  codeKataUnit.definition = codeKataUnit.code.substring(0, firstSeparator).trim();\r\n  codeKataUnit.test = codeKataUnit.code.substring(lastSeparator, codeKataUnit.code.length).trim();\r\n  codeKataUnit.code = codeKataUnit.code.substring(firstSeparator, lastSeparator).trim();\r\n\r\n  codeKataUnit.code = codeKataUnit.code.slice(codeKataUnit.code.search('\\n')).trim();\r\n  codeKataUnit.test = codeKataUnit.test.slice(codeKataUnit.test.search('\\n')).trim();\r\n  next();\r\n}\r\n\r\nfunction findFirstIndexOf(source: string, value: string): number {\r\n  return source.search(value);\r\n}\r\n\r\nfunction findLastIndexOf(source: string, value: string): number {\r\n  const regex = new RegExp(value, '');\r\n  let i = -1;\r\n\r\n  // limit execution time (prevent deadlocks)\r\n  let j = 10;\r\n  while (j > 0) {\r\n    j--;\r\n    const result = regex.exec(source.slice(++i));\r\n    if (result != null) {\r\n      i += result.index;\r\n    } else {\r\n      i--;\r\n      break;\r\n    }\r\n  }\r\n  return i;\r\n}\r\n\r\nfunction validateTestArea(testArea: any) {\r\n  if (!testArea.match(new RegExp('function(.|\\t)*validate\\\\(\\\\)(.|\\n|\\t)*{(.|\\n|\\t)*}', 'gmi'))) {\r\n    throw new BadRequestError('The test section must contain a validate function');\r\n  }\r\n  if (!testArea.match(new RegExp('function(.|\\t)*validate\\\\(\\\\)(.|\\n|\\t)*{(.|\\n|\\t)*return(.|\\n|\\t)*}', 'gmi'))) {\r\n    throw new BadRequestError('The validate function must return something');\r\n  }\r\n  if (!testArea.match(new RegExp('validate\\\\(\\\\);', 'gmi'))) {\r\n    throw new BadRequestError('The test section must call the validate function');\r\n  }\r\n\r\n  return true;\r\n}\r\n\r\ncodeKataSchema.pre('validate', splitCodeAreas);\r\ncodeKataSchema.path('test').validate(validateTestArea);\r\n\r\ncodeKataSchema.methods.toHtmlForIndividualPDF = function (): String {\r\n  const md = new MarkdownIt({html: true});\r\n  let html = '<div id=\"pageHeader\">'\r\n    + md.render(this.name ? this.name : '') + md.render(this.description ? this.description : '') + '</div>';\r\n\r\n\r\n  html += '<div id=\"firstPage\" class=\"bottomBoxWrapper\">';\r\n  html += '<h5>Task</h5>';\r\n  html += '<div>' +  md.render('<div class=\"codeBox\">' + md.render(this.definition ? this.definition : '') + '</div>') + '</div>';\r\n  html += '<h5>Code</h5>';\r\n  html += '<div class=\"bottomBox\"><h3>Validation</h3>';\r\n  html += '<div>' +  md.render('<div class=\"codeBox\">' + md.render(this.test ? this.test : '') + '</div>') + '</div>';\r\n  html += '</div>';\r\n\r\n  html += '</div ><div><h2>Solution</h2></div>';\r\n  html += '<h5>Task</h5>';\r\n  html += '<div>' +  md.render('<div class=\"codeBox\">' +  md.render(this.definition ? this.definition : '') + '</div>') + '</div>';\r\n  html += '<h5>Code</h5>';\r\n  html += '<div>' +  md.render('<div class=\"codeBox\">' + md.render(this.code ? this.code : '') + '</div>') + '</div>';\r\n  html += '<h5>Validation</h5>';\r\n  html += '<div>' +  md.render('<div class=\"codeBox\">' +  md.render(this.test ? this.test : '') + '</div>') + '</div>';\r\n  return html;\r\n};\r\n\r\ncodeKataSchema.methods.toHtmlForSinglePDF = function (): String {\r\n  const md = new MarkdownIt({html: true});\r\n\r\n\r\n  let html = '<div class=\"bottomBoxWrapper\">';\r\n  html += '<div><h4>' + md.render(this.name ? 'Unit: ' + this.name : '') + '</h4>'\r\n    + '<span>' + md.render(this.description ? 'Description: ' + this.description : '') + '</span></div>';\r\n  html += '<h5>Task</h5>';\r\n  html += '<div>' +  md.render('<div class=\"codeBox\">' + md.render(this.definition ? this.definition : '') + '</div>') + '</div>';\r\n  html += '<h5>Code</h5>';\r\n  html += '<div class=\"bottomBox\"><h5>Validation</h5>';\r\n  html += '<div>' +  md.render('<div class=\"codeBox\">' + md.render(this.test ? this.test : '') + '</div>') + '</div>';\r\n  html += '</div></div>';\r\n  return html;\r\n};\r\n\r\ncodeKataSchema.methods.toHtmlForSinglePDFSolutions = function (): String {\r\n  const md = new MarkdownIt({html: true});\r\n\r\n  let html = '';\r\n  html += '<div><h4>' + md.render(this.name ? this.name : '') + '</h4></div>';\r\n  html += '<h5>Task</h5>';\r\n  html += '<div>' +  md.render('<div class=\"codeBox\">' +  md.render(this.definition ? this.definition : '') + '</div>') + '</div>';\r\n  html += '<h5>Code</h5>';\r\n  html += '<div>' +  md.render('<div class=\"codeBox\">' + md.render(this.code ? this.code : '') + '</div>') + '</div>';\r\n  html += '<h5>Validation</h5>';\r\n  html += '<div>' +  md.render('<div class=\"codeBox\">' + md.render(this.test ? this.test : '') + '</div>') + '</div>';\r\n  return html;\r\n};\r\n\r\nexport {codeKataSchema, ICodeKataModel};\r\n"]}