{"version":3,"sources":["src/models/units/Unit.ts"],"names":[],"mappings":"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","file":"../../../../src/models/units/Unit.js","sourcesContent":["import * as mongoose from 'mongoose';\r\nimport {IUnit} from '../../../../shared/models/units/IUnit';\r\nimport {Progress} from '../progress/Progress';\r\nimport {InternalServerError} from 'routing-controllers';\r\n\r\nimport {Lecture} from '../Lecture';\r\nimport {freeTextUnitSchema} from './FreeTextUnit';\r\nimport {codeKataSchema} from './CodeKataUnit';\r\nimport {fileUnitSchema} from './FileUnit';\r\nimport {taskUnitSchema} from './TaskUnit';\r\nimport {assignmentsSchema} from './AssignmentUnit';\r\nimport {IUser} from '../../../../shared/models/IUser';\r\nimport {IProgress} from '../../../../shared/models/progress/IProgress';\r\nimport {User} from '../User';\r\nimport {ChatRoom} from '../ChatRoom';\r\n\r\ninterface IUnitModel extends IUnit, mongoose.Document {\r\n  exportJSON: (onlyBasicData?: boolean) => Promise<IUnit>;\r\n  calculateProgress: (users: IUser[], progress: IProgress[]) => Promise<IUnit>;\r\n  populateUnit: () => Promise<IUnitModel>;\r\n  secureData: (user: IUser) => Promise<IUnitModel>;\r\n  toHtmlForIndividualPDF: () => String;\r\n  toHtmlForSinglePDF: () => String;\r\n  toHtmlForSinglePDFSolutions: () => String;\r\n}\r\n\r\nconst unitSchema = new mongoose.Schema({\r\n    _course: {\r\n      type: mongoose.Schema.Types.ObjectId,\r\n      ref: 'Course'\r\n    },\r\n    name: {\r\n      type: String,\r\n      required: true\r\n    },\r\n    description: {\r\n      type: String\r\n    },\r\n    progressable: {\r\n      type: Boolean\r\n    },\r\n    weight: {\r\n      type: Number\r\n    },\r\n    type: {\r\n      type: String\r\n    },\r\n    visible: {\r\n      type: Boolean,\r\n      default: false,\r\n    },\r\n    unitCreator: {\r\n      type: mongoose.Schema.Types.ObjectId,\r\n      ref: 'User'\r\n    },\r\n    chatRoom: {\r\n      type: mongoose.Schema.Types.ObjectId,\r\n      ref: 'ChatRoom'\r\n    }\r\n  },\r\n  {\r\n    collection: 'units',\r\n    timestamps: true,\r\n    toObject: {\r\n      virtuals: true,\r\n      transform: function (doc: IUnitModel, ret: any) {\r\n        if (ret._id) {\r\n          ret._id = ret._id.toString();\r\n        }\r\n\r\n        if (ret._course) {\r\n          ret._course = ret._course.toString();\r\n        }\r\n\r\n        if (ret.hasOwnProperty('chatRoom') && ret.chatRoom) {\r\n          ret.chatRoom = ret.chatRoom.toString();\r\n        }\r\n      }\r\n    },\r\n  }\r\n);\r\n\r\n\r\nunitSchema.pre('save', async function () {\r\n  const unit = <IUnitModel> this;\r\n  if (this.isNew) {\r\n   const chatRoom = await ChatRoom.create({\r\n      room: {\r\n        roomType: 'Unit',\r\n        roomFor: unit\r\n      }\r\n    });\r\n    unit.chatRoom = chatRoom._id;\r\n  }\r\n});\r\n\r\nunitSchema.virtual('progressData', {\r\n  ref: 'Progress',\r\n  localField: '_id',\r\n  foreignField: 'unit',\r\n  justOne: true\r\n});\r\n\r\nunitSchema.methods.exportJSON = function (onlyBasicData: boolean= false) {\r\n  const obj = this.toObject();\r\n\r\n  // remove unwanted informations\r\n  // mongo properties\r\n  delete obj._id;\r\n  delete obj.createdAt;\r\n  delete obj.__v;\r\n  delete obj.updatedAt;\r\n  delete obj.unitCreator;\r\n  delete obj.files;\r\n\r\n  // custom properties\r\n  delete obj._course;\r\n\r\n  if (onlyBasicData) {\r\n    delete obj.id;\r\n    delete obj.progressData;\r\n  }\r\n\r\n  return obj;\r\n};\r\n\r\nunitSchema.methods.calculateProgress = async function (): Promise<IUnit> {\r\n  return this.toObject();\r\n};\r\n\r\nunitSchema.methods.populateUnit = async function (): Promise<IUnit> {\r\n  if (this.unitCreator) {\r\n    this.unitCreator = await User.findById(this.unitCreator);\r\n  }\r\n  return this;\r\n};\r\n\r\nunitSchema.methods.secureData = async function (user: IUser): Promise<IUnitModel> {\r\n  if (this.unitCreator) {\r\n    this.unitCreator = User.forSafe(this.unitCreator);\r\n  }\r\n  return this;\r\n};\r\n\r\nunitSchema.methods.toFile = function (): String {\r\n  return '';\r\n};\r\n\r\nunitSchema.statics.importJSON = async function (unit: IUnit, courseId: string, lectureId: string) {\r\n  unit._course = courseId;\r\n  try {\r\n    // Need to disabled this rule because we can't export 'Unit' BEFORE this function-declaration\r\n    // tslint:disable:no-use-before-declare\r\n    const savedUnit = await Unit.create(unit);\r\n    const lecture = await Lecture.findById(lectureId);\r\n    lecture.units.push(savedUnit);\r\n    await lecture.save();\r\n\r\n    return savedUnit.toObject();\r\n    // tslint:enable:no-use-before-declare\r\n  } catch (err) {\r\n    const newError = new InternalServerError('Failed to import unit of type ' + unit.__t);\r\n    newError.stack += '\\nCaused by: ' + err.message + '\\n' + err.stack;\r\n    throw newError;\r\n  }\r\n};\r\n\r\n// Cascade delete\r\nunitSchema.pre('remove', async function () {\r\n  try {\r\n    await Progress.remove({'unit': this._id}).exec();\r\n  } catch (err) {\r\n    throw new Error('Delete Error: ' + err.toString());\r\n  }\r\n});\r\n\r\nconst Unit = mongoose.model<IUnitModel>('Unit', unitSchema);\r\nconst FreeTextUnit = Unit.discriminator('free-text', freeTextUnitSchema);\r\nconst CodeKataUnit = Unit.discriminator('code-kata', codeKataSchema);\r\nconst FileUnit = Unit.discriminator('file', fileUnitSchema);\r\nconst TaskUnit = Unit.discriminator('task', taskUnitSchema);\r\nconst AssignmentUnit = Unit.discriminator('assignment', assignmentsSchema);\r\n\r\nexport {Unit, FreeTextUnit, CodeKataUnit, FileUnit, TaskUnit, AssignmentUnit, IUnitModel};\r\n"]}